name: Build Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Add repository DID to metadata
      run: npm run add-repo-did
      env:
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_REF: ${{ github.ref }}
        NODE_ENV: production
      
    - name: TypeScript type check
      run: npm run type-check
      
    - name: Build project
      run: npm run build
      
    - name: Verify build outputs
      run: |
        if [ ! -d "dist" ]; then
          echo "âŒ Build output directory 'dist' not found"
          exit 1
        fi
        if [ ! -d "types" ]; then
          echo "âŒ Types output directory 'types' not found"
          exit 1
        fi
        if [ ! -f "dist/did-metadata.json" ]; then
          echo "âŒ DID metadata not found"
          exit 1
        fi
        echo "âœ… Build verification successful"
      
    - name: Verify DID metadata
      run: |
        echo "ðŸ“‹ DID Metadata Contents:"
        cat dist/did-metadata.json | jq '.'
        
        # Extract and verify DID
        REPO_DID=$(cat dist/did-metadata.json | jq -r '.repository.did')
        echo "ðŸ†” Repository DID: $REPO_DID"
        
        # Verify DID format
        if [[ $REPO_DID =~ ^did:cheqd:mainnet:[a-f0-9-]+$ ]]; then
          echo "âœ… DID format is valid"
        else
          echo "âŒ Invalid DID format: $REPO_DID"
          exit 1
        fi
        
    - name: Upload DID metadata artifact
      uses: actions/upload-artifact@v3
      with:
        name: did-metadata
        path: dist/did-metadata.json
        retention-days: 30
        
    - name: Build status summary
      run: |
        echo "## ðŸŽ‰ Build Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… TypeScript compilation: PASSED" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Type generation: PASSED" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… DID metadata: GENERATED" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Build verification: PASSED" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ†” Repository Information" >> $GITHUB_STEP_SUMMARY
        echo "- **DID**: $(cat dist/did-metadata.json | jq -r '.repository.did')" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ Ready for deployment!"  >> $GITHUB_STEP_SUMMARY 